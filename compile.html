<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>JOR1K Compiler Demo</title>
        <link rel="stylesheet" href="css/default.css">
    </head>
    <body onload="Start()">
    <div >
        <table>
            <tr>
                <td style="vertical-align: top">
                    <table>
                    <tr><td>
                    <canvas id="tty" class="screen" width="640" height="384">
                        Terminal uses canvas
                    </canvas>
                    </td></tr>
                    <tr><td>
                    <span style="float: left">
                    <form>VM Control
                        <select id="coreselect" onchange='jor1kgui.ChangeCore(this.options[this.selectedIndex].value)'>
                            <option value="asm">asm.js Core</option>
                            <option value="std">Standard Core</option>
                            <option value="safe">Safe Core (Slow)</option>
                        </select>

                    <button type='button' onclick='jor1kgui.Reset()'>Reset</button>
                    <button type='button' onclick='jor1kgui.Pause(true)'>Pause</button>
                    <button type='button' onclick='jor1kgui.Pause(false)'>Run</button>
                    </form>                    </span>
                    <span id="stats" style="float: right"></span>
                    </td></tr>
                    </table>

                </td>
                <td style="vertical-align: top">
<div id="code" style="width: 640px; height: 388px; margin-top: 2px">#include &lt;stdio.h&gt;
int main() {
    printf("Hello World!\n");
    return 0;
}
</div>

gcc options:<input type="text" maxlen=32 id="gccoptions" value="-lm -Wall"></input><button type='button' onclick= "RunCode(GetCodeText(),document.getElementById('gccoptions').value);return false;" >Compile and run</button>
<span style="margin: 0 5px 0 5px" id="gcc-compile-status"></span>Theme<select onchange='editor.setTheme("ace/theme/"+this.options[this.selectedIndex].value)'>
  <option value="monokai">monokai</option>
  <option value="terminal">terminal</option>
  <option value="tomorrow">tomorrow</option>
  <option value="xcode">xcode</option>
</select>

                </td>
            </tr>
        </table>
       
        </div>
        <div class="infobox">
        </div>

    <div>
        <p>GCC output:</p>
        <textarea id="gcc-output" rows="20" cols="60" disabled></textarea>
    </div>

    <script src="js/master/terminal.js"></script>
    <script src="js/master/terminal-input.js"></script>
    <script src="js/master/ethernet.js"></script>
    <script src="js/master/master.js"></script>
   <script src="js/lib/ace-editor-src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
function Start() {
    CreateEditor();
    document.addEventListener("jor1k_terminal_put_char", terminalPutCharListener, false);
    jor1kgui = new jor1kGUI("tty", "fb", "stats", ["../../bin/vmlinux.bin.bz2", "../../bin/hdgcc.bz2"], "ws://relay.widgetry.org/");
}


var term_output = "";
var gcc_output_capture_re = /###GCC_COMPILE###\s*([\S\s]*?)\s*###GCC_COMPILE_FINISHED###/;

function terminalPutCharListener(e)
{
    term_output = term_output + e.detail.character;
}

function waitForGccCompletion() {

    console.log(term_output);
    var regex_match_array = gcc_output_capture_re.exec(term_output);

    if (regex_match_array !== null) {
        var gcc_output = regex_match_array[1];
        document.getElementById('gcc-output').value = gcc_output;
        SendKeysToJor1k("clear\n");
        if (gcc_output === "") {
            document.getElementById('gcc-compile-status').innerHTML = '<span style="color: green">SUCCESS</span>';
            SendKeysToJor1k("./program\n");
        }
        else {
            document.getElementById('gcc-compile-status').innerHTML = '<span style="color: red">FAILED</span>';
            editor.getSession().setAnnotations(getErrorAnnotations(gcc_output));
        }
    }
    else {
        document.getElementById('gcc-compile-status').innerHTML = '<span style="color: gray">COMPILING</span>';
        setTimeout(waitForGccCompletion, 1000);
    }
}

var gcc_output_parse_re = /(\d+):(\d+):\s*([\w]+):\s*(.+)/g;
function getErrorAnnotations(gcc_output_str) {
    var match, errors = [];
    gcc_output_str.split("prog.c").forEach(function (error_line) {
        if(match = gcc_output_parse_re.exec(error_line)) {
            errors.push({
                row: match[1] - 1, // line numbers in ace start from zero
                column: match[2],
                type: match[3], // ace supports error, warning or information
                text: match[4]
            });
        }
    });
    return errors;
}

function CreateEditor()
{
    editor = ace.edit("code");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/c_cpp");
}

function GetCodeText() {
   //return document.getElementById('code').value; // textarea
   return editor.getSession().getValue(); //ace
}

function SendKeysToJor1k(text,quiet) {
  var tty = quiet ? "tty1" : "tty0";
  for(var i=0;i<text.length;i++) {
    jor1kgui.SendToWorker(tty, text.charCodeAt(i) >>>0);
  }
}

function RunCode(code,gccoptions) {
   if(code.length ===0 || code.indexOf("\x03") >= 0 || code.indexOf("\x04") >= 0 ) return;           

   jor1kgui.Pause(false);
    // wakeup tty0
   SendKeysToJor1k("\x03\n\nstty -clocal\nstty crtscts\nstty -ixoff\n",false); 
// wakeup hidden tty1
//tty1-unusedfornow SendKeysToJor1k("\x03\n",true);
   
   SendKeysToJor1k("cd ~;rm prog.c program 2>/dev/null\n");
   // not-reliable SendKeysToJor1k("stty -echo\n\n");   // Does not work reliably

   switch(3) {
	   case 1: // dd - does not work
	     SendKeysToJor1k("dd ibs=1 of=prog.c count="+code.length+"\n");
	     SendKeysToJor1k(code);
	   break;
	   case 2:  // cat - does not work
	     SendKeysToJor1k("cat >prog.c\n");
	     SendKeysToJor1k(code);
	     SendKeysToJor1k("\x04"); //  why does this not work?
	   break
	   case 3:  // brain dead echo does work
	     codeArray= code.match(/[^]{1,256}/gim); // Avoid 1K line-limit (assume escape expansion) so split programing into shorter chuncks
	     for(var i=0; i < codeArray.length;i++) {
	          // For happiness, escape *after* splitting
	          var escaped = codeArray[i] .replace(/\\/g,"\\134").replace(/\t/g,"\\t")
	                   .replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/"/gm,'\\"');
	          //Todo Handle all chars in the sent file i.e. replace <=0x2f with \xnn

	          SendKeysToJor1k('echo -n -e "');
	          SendKeysToJor1k(escaped);
	          SendKeysToJor1k('\">> prog.c\n');
	     }
	}
   // For now we want gcc output to be viewable, so this goes on the main terminal
   // To use tty1 we would need to synchronize gcc i.e. wait for prog.c upload

      // not-reliable SendKeysToJor1k("stty echo\n\nclear\n");
    term_output = "";
    SendKeysToJor1k("echo \\#\\#\\#GCC_COMPILE\\#\\#\\#;clear;gcc " + gccoptions + " prog.c -o program;echo \\#\\#\\#GCC_COMPILE_FINISHED\\#\\#\\#;clear\n");
    waitForGccCompletion();
}
</script>

    </body>
</html>
